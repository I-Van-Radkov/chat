<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Анонимный чат</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        #chat-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        #messages {
            height: 400px;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        .message {
            max-width: 70%;
            padding: 10px 15px;
            margin-bottom: 10px;
            border-radius: 18px;
            word-wrap: break-word;
        }
        .received {
            align-self: flex-start;
            background-color: #e5e5ea;
            color: black;
        }
        .sent {
            align-self: flex-end;
            background-color: #007aff;
            color: white;
        }
        #status {
            padding: 10px 20px;
            background-color: #f0f0f0;
            border-bottom: 1px solid #ddd;
            font-weight: bold;
        }
        #input-area {
            display: flex;
            padding: 15px;
            background-color: #f0f0f0;
        }
        #message-input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 20px;
            outline: none;
        }
        #send-button {
            margin-left: 10px;
            padding: 10px 20px;
            background-color: #007aff;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
        }
        #send-button:hover {
            background-color: #0062cc;
        }
        .disconnect-btn {
            background-color: #ff3b30;
            margin-left: 10px;
        }
        .disconnect-btn:hover {
            background-color: #d70000;
        }
    </style>
</head>
<body>
    <div id="chat-container">
        <div id="status">Подключение к серверу...</div>
        <div id="messages"></div>
        <div id="input-area">
            <input type="text" id="message-input" placeholder="Введите сообщение..." disabled>
            <button id="send-button" disabled>Отправить</button>
            <button id="disconnect-button" class="disconnect-btn" disabled>Закончить чат</button>
        </div>
    </div>

    <script>
        // Генерируем или получаем ID пользователя из localStorage
        let userId = localStorage.getItem('userId');
        if (!userId) {
            userId = crypto.randomUUID();
            localStorage.setItem('userId', userId);
        }

        let socket;
        let isConnected = false;
        let partnerConnected = false;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;
        const reconnectDelay = 3000; // 3 секунды

        // Элементы интерфейса
        const statusElement = document.getElementById('status');
        const messagesElement = document.getElementById('messages');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const disconnectButton = document.getElementById('disconnect-button');

        // Функция подключения к WebSocket
        function connect() {
            // Определяем URL WebSocket сервера
            const wsProtocol = 'ws://';
            const wsUrl = wsProtocol + "localhost:8080" + '/ws?user_id=' + userId;
            
            socket = new WebSocket(wsUrl);

            socket.onopen = function() {
                isConnected = true;
                reconnectAttempts = 0;
                updateStatus('Ожидание собеседника...');
                enableInput(false);
                console.log('WebSocket соединение установлено');
            };

            socket.onmessage = function(event) {
                const message = event.data;
                
                if (message === 'Собеседник найден') {
                    partnerConnected = true;
                    updateStatus('Собеседник найден! Можете общаться');
                    enableInput(true);
                    addMessage('system', 'Собеседник подключился к чату');
                } 
                else if (message === 'Чат завершен!') {
                    handleDisconnect();
                    addMessage('system', 'Чат завершен');
                }
                else if (message === 'Ожидание собеседника') {
                    updateStatus('Ожидание собеседника...');
                    addMessage('system', 'Ищем собеседника для вас...');
                }
                else if (message === 'Ваш партнер вернулся в чат') {
                    partnerConnected = true;
                    addMessage('system', 'Собеседник вернулся в чат');
                }
                else {
                    addMessage('received', message);
                }
            };

            socket.onclose = function(event) {
                isConnected = false;
                partnerConnected = false;
                
                if (event.wasClean) {
                    console.log(`Соединение закрыто чисто, код=${event.code} причина=${event.reason}`);
                } else {
                    console.log('Соединение прервано');
                    if (reconnectAttempts < maxReconnectAttempts) {
                        reconnectAttempts++;
                        const delay = reconnectAttempts * reconnectDelay;
                        updateStatus(`Соединение потеряно. Попытка переподключения ${reconnectAttempts}/${maxReconnectAttempts} через ${delay/1000} сек...`);
                        setTimeout(connect, delay);
                    } else {
                        updateStatus('Не удалось подключиться к серверу. Обновите страницу.');
                    }
                }
                
                enableInput(false);
            };

            socket.onerror = function(error) {
                console.error('Ошибка WebSocket:', error);
                updateStatus('Ошибка соединения');
            };
        }

        // Функция отправки сообщения
        function sendMessage() {
            const message = messageInput.value.trim();
            if (message && isConnected && partnerConnected) {
                socket.send(message);
                addMessage('sent', message);
                messageInput.value = '';
                
                // Особый случай - команда завершения чата
                if (message === '!с') {
                    handleDisconnect();
                }
            }
        }

        // Функция отключения от чата
        function disconnect() {
            if (isConnected) {
                socket.send('!с');
                handleDisconnect();
            }
        }

        // Обработчик отключения
        function handleDisconnect() {
            partnerConnected = false;
            enableInput(false);
            updateStatus('Чат завершен. Подключение к серверу...');
            
            // Очищаем сообщения при новом подключении
            messagesElement.innerHTML = '';
            
            // Переподключаемся для поиска нового собеседника
            if (isConnected) {
                socket.close();
            } else {
                connect();
            }
        }

        // Добавление сообщения в чат
        function addMessage(type, text) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');
            messageDiv.classList.add(type);
            messageDiv.textContent = text;
            messagesElement.appendChild(messageDiv);
            messagesElement.scrollTop = messagesElement.scrollHeight;
        }

        // Обновление статуса
        function updateStatus(text) {
            statusElement.textContent = text;
        }

        // Включение/выключение полей ввода
        function enableInput(enabled) {
            messageInput.disabled = !enabled;
            sendButton.disabled = !enabled;
            disconnectButton.disabled = !enabled;
            
            if (enabled) {
                messageInput.focus();
            }
        }

        // Обработчики событий
        sendButton.addEventListener('click', sendMessage);
        disconnectButton.addEventListener('click', disconnect);
        
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            connect();
            
            // Сохраняем socket в localStorage для доступа из других вкладок
            window.addEventListener('beforeunload', function() {
                localStorage.setItem('lastSessionUserId', userId);
            });
            
            // Проверяем, есть ли активная сессия в других вкладках
            window.addEventListener('storage', function(event) {
                if (event.key === 'lastSessionUserId' && event.newValue === userId) {
                    // Другая вкладка с тем же пользователем обновилась
                    console.log('Обнаружена другая вкладка с тем же пользователем');
                }
            });
        });
    </script>
</body>
</html>